<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>加密查询测试</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
    <h1>加密查询测试</h1>
    <button onclick="queryData()">查询数据</button>
    <pre id="result"></pre>

    <script>
        // AES 加密配置，与后端一致
        const SECRET_KEY = 'xAI_Grok3_2025_16bytes_key123456'; // 32 字节
        const IV = '1234567890abcdef'; // 16 字节

        // AES 加密函数
        function encryptData(data) {
            const key = CryptoJS.enc.Utf8.parse(SECRET_KEY);
            const iv = CryptoJS.enc.Utf8.parse(IV);
            const encrypted = CryptoJS.AES.encrypt(data, key, {
                iv: iv,
                mode: CryptoJS.mode.CBC,
                padding: CryptoJS.pad.Pkcs7
            });
            return encrypted.toString();
        }

        // AES 解密函数
        function decryptData(encrypted) {
            const key = CryptoJS.enc.Utf8.parse(SECRET_KEY);
            const iv = CryptoJS.enc.Utf8.parse(IV);
            const decrypted = CryptoJS.AES.decrypt(encrypted, key, {
                iv: iv,
                mode: CryptoJS.mode.CBC,
                padding: CryptoJS.pad.Pkcs7
            });
            return decrypted.toString(CryptoJS.enc.Utf8);
        }

        // 查询数据
        async function queryData() {
            try {
                // 构造请求参数
                const params = { query: "test" };
                const paramsJson = JSON.stringify(params);
                
                // 加密参数
                const encryptedParams = encryptData(paramsJson);
                
                // 构造请求体
                const requestBody = JSON.stringify({ data: encryptedParams });
                const encryptedBody = encryptData(requestBody);
                
                // 发送请求
                const response = await axios.post('/query', encryptedBody, {
                    headers: { 'Content-Type': 'text/plain' }
                });
                
                // 解密响应体
                const decryptedBody = decryptData(response.data);
                const responseJson = JSON.parse(decryptedBody);
                const encryptedResponseData = responseJson.data;
                const decryptedResponseData = decryptData(encryptedResponseData);
                
                // 显示结果
                document.getElementById('result').textContent = decryptedResponseData;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('result').textContent = '查询失败: ' + error.message;
            }
        }
    </script>
</body>
</html>
